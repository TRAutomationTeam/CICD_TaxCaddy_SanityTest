name: Development workflow

on:
  push:
    branches:
      - main
    paths:
      - 'Configue-CICD.txt'

env: 
  PROJECT_FOLDER: ${{ github.action_path }}
  ORCH_URL: ${{ secrets.UIPATH_ORCH_URL }}
  ORCH_TENANT: ${{ secrets.UIPATH_TENANT_ID }}
  ORCH_CLIENT_ID: ${{ secrets.UIPATH_CLIENT_ID }}
  ORCH_USER_KEY: ${{ secrets.UIPATH_USER_KEY }}
  ORCH_ACC_NAME: ${{ secrets.UIPATH_ACCOUNT_ID }}

jobs:
  print-details:
    runs-on: self-hosted
    steps:
      - name: echo-default-env-variables
        shell: pwsh
        run: |
          Write-Host "=== ENVIRONMENT VARIABLES ===" -ForegroundColor Yellow
          Write-Host "Home: $env:HOME"
          Write-Host "GITHUB_WORKFLOW: $env:GITHUB_WORKFLOW"
          Write-Host "GITHUB_ACTIONS: $env:GITHUB_ACTIONS"
          Write-Host "GITHUB_ACTOR: $env:GITHUB_ACTOR"
          Write-Host "GITHUB_REPOSITORY: $env:GITHUB_REPOSITORY"
          Write-Host "GITHUB_EVENT_NAME: $env:GITHUB_EVENT_NAME"
          Write-Host "GITHUB_WORKSPACE: $env:GITHUB_WORKSPACE"
          Write-Host "GITHUB_SHA: $env:GITHUB_SHA"
          Write-Host "GITHUB_REF: $env:GITHUB_REF"

  # ✅ ENHANCED CLEANER - Force remove all files including hidden/system files
  cleaner:
    runs-on: self-hosted
    steps:
      - name: Force clean workspace with enhanced permissions
        shell: pwsh
        run: |
          Write-Host "=== ENHANCED WORKSPACE CLEANING ===" -ForegroundColor Yellow
          $workspace = "${{ github.workspace }}"
          Write-Host "Target workspace: $workspace" -ForegroundColor Cyan
          
          if (Test-Path $workspace) {
            Write-Host "Workspace exists, performing deep clean..." -ForegroundColor Yellow
            
            # Method 1: Try PowerShell removal first
            try {
              Get-ChildItem -Path $workspace -Force -Recurse -ErrorAction SilentlyContinue | 
                ForEach-Object { 
                  try {
                    $_.Delete()
                  } catch {
                    Write-Host "Could not delete: $($_.FullName)" -ForegroundColor Red
                  }
                }
              
              # Remove the directories
              Get-ChildItem -Path $workspace -Directory -Force -ErrorAction SilentlyContinue | 
                Remove-Item -Force -Recurse -ErrorAction SilentlyContinue
                
              # Remove remaining files
              Get-ChildItem -Path $workspace -File -Force -ErrorAction SilentlyContinue | 
                Remove-Item -Force -ErrorAction SilentlyContinue
                
            } catch {
              Write-Host "PowerShell cleanup failed: $_" -ForegroundColor Red
            }
            
            # Method 2: Use CMD for stubborn files (Windows)
            if ($IsWindows -or $env:OS -eq "Windows_NT") {
              Write-Host "Using CMD for Windows cleanup..." -ForegroundColor Yellow
              try {
                cmd /c "rmdir /s /q `"$workspace`" 2>nul"
                cmd /c "del /f /s /q `"$workspace\*.*`" 2>nul"
              } catch {
                Write-Host "CMD cleanup had issues: $_" -ForegroundColor Red
              }
            }
            
            # Method 3: Create fresh directory
            if (-not (Test-Path $workspace)) {
              New-Item -ItemType Directory -Path $workspace -Force | Out-Null
              Write-Host "Created fresh workspace directory" -ForegroundColor Green
            }
            
          } else {
            Write-Host "Workspace doesn't exist, creating..." -ForegroundColor Green
            New-Item -ItemType Directory -Path $workspace -Force | Out-Null
          }
          
      - name: Verify complete cleanup
        shell: pwsh
        run: |
          Write-Host "=== CLEANUP VERIFICATION ===" -ForegroundColor Yellow
          $workspace = "${{ github.workspace }}"
          
          if (Test-Path $workspace) {
            $items = @(Get-ChildItem -Path $workspace -Force -Recurse -ErrorAction SilentlyContinue)
            if ($items.Count -eq 0) {
              Write-Host "✅ Workspace is completely clean" -ForegroundColor Green
            } else {
              Write-Host "⚠️ $($items.Count) items still present:" -ForegroundColor Yellow
              $items | ForEach-Object { Write-Host "  $($_.FullName)" -ForegroundColor Red }
            }
          } else {
            Write-Host "✅ Workspace directory ready" -ForegroundColor Green
          }

  config:
    needs: [cleaner]
    runs-on: self-hosted
    outputs:
      build: ${{ steps.get_build.outputs.build }}
      run: ${{ steps.get_run.outputs.run }}
      deploy: ${{ steps.get_deploy.outputs.deploy }}
    steps:
      # ✅ ENHANCED CHECKOUT - Force fresh checkout with all options
      - name: Force fresh repository checkout
        uses: actions/checkout@v4
        with:
          # Force a complete fresh checkout
          fetch-depth: 0          # Fetch all history
          clean: true             # Clean the repository  
          force: true             # Force clean even if local changes
          submodules: false       # Don't checkout submodules (can cause issues)
          token: ${{ github.token }}
          
      # ✅ ADDITIONAL CLEANUP AFTER CHECKOUT
      - name: Post-checkout cleanup verification
        shell: pwsh
        run: |
          Write-Host "=== POST-CHECKOUT VERIFICATION ===" -ForegroundColor Yellow
          $workspace = "${{ github.workspace }}"
          
          # Remove any potential Git locks or temp files
          $gitLockFiles = @(
            "$workspace\.git\index.lock",
            "$workspace\.git\HEAD.lock",
            "$workspace\.git\config.lock"
          )
          
          foreach ($lockFile in $gitLockFiles) {
            if (Test-Path $lockFile) {
              Remove-Item $lockFile -Force -ErrorAction SilentlyContinue
              Write-Host "Removed Git lock: $lockFile" -ForegroundColor Yellow
            }
          }
          
          # Verify key files exist
          $criticalFiles = @("Configue-CICD.txt", "project.json")
          foreach ($file in $criticalFiles) {
            $fullPath = Join-Path $workspace $file
            if (Test-Path $fullPath) {
              $lastWrite = (Get-Item $fullPath).LastWriteTime
              Write-Host "✅ $file (Modified: $lastWrite)" -ForegroundColor Green
            } else {
              Write-Host "❌ Missing: $file" -ForegroundColor Red
            }
          }
          
          # Show all repository contents with timestamps
          Write-Host "`n📁 Repository Contents:" -ForegroundColor Cyan
          Get-ChildItem -Path $workspace -Force | ForEach-Object {
            $type = if ($_.PSIsContainer) { "📁" } else { "📄" }
            Write-Host "  $type $($_.Name) (Modified: $($_.LastWriteTime))" -ForegroundColor White
          }
          
      - name: Get BUILD value from Configure-CICD.txt
        id: get_build
        shell: pwsh
        run: |
          $configFile = "${{ github.workspace }}/Configue-CICD.txt"
          if (-not (Test-Path $configFile)) {
            Write-Error "❌ Configuration file not found: $configFile"
            Write-Host "Available files:" -ForegroundColor Yellow
            Get-ChildItem "${{ github.workspace }}" | ForEach-Object { Write-Host "  $($_.Name)" }
            exit 1
          }
          
          Write-Host "📖 Reading config from: $configFile" -ForegroundColor Cyan
          $content = Get-Content $configFile -Raw
          Write-Host "File content length: $($content.Length) characters" -ForegroundColor Yellow
          
          $build = (Get-Content $configFile | Where-Object { $_ -match '^BUILD[ ]*-[ ]*(.+)$' }) -replace '^BUILD[ ]*-[ ]*',''
          Write-Host "BUILD value extracted: '$build'" -ForegroundColor Green
          echo "build=$build" >> $env:GITHUB_OUTPUT
          
      - name: Get RUN value from Configure-CICD.txt
        id: get_run
        shell: pwsh
        run: |
          $configFile = "${{ github.workspace }}/Configue-CICD.txt"
          $run = (Get-Content $configFile | Where-Object { $_ -match '^RUN[ ]*-[ ]*(.+)$' }) -replace '^RUN[ ]*-[ ]*',''
          Write-Host "RUN value extracted: '$run'" -ForegroundColor Green
          echo "run=$run" >> $env:GITHUB_OUTPUT
          
      - name: Get DEPLOY value from Configure-CICD.txt
        id: get_deploy
        shell: pwsh
        run: |
          $configFile = "${{ github.workspace }}/Configue-CICD.txt"
          $deploy = (Get-Content $configFile | Where-Object { $_ -match '^DEPLOY[ ]*-[ ]*(.+)$' }) -replace '^DEPLOY[ ]*-[ ]*',''
          Write-Host "DEPLOY value extracted: '$deploy'" -ForegroundColor Green
          echo "deploy=$deploy" >> $env:GITHUB_OUTPUT
          
      - name: Write ENVIRONMENT value to file
        shell: pwsh
        run: |
          $configFile = "${{ github.workspace }}/Configue-CICD.txt"
          $envValue = (Get-Content $configFile | Where-Object { $_ -match '^[ ]*ENVIRONMENT[ ]*-[ ]*(.+)$' }) -replace '^[ ]*ENVIRONMENT[ ]*-[ ]*',''
          Write-Host "ENVIRONMENT value extracted: '$envValue'" -ForegroundColor Green
          
          $outputPath = 'C:\Automation Team\CICD'
          if (!(Test-Path $outputPath)) { New-Item -Path $outputPath -ItemType Directory -Force }
          $envFile = Join-Path $outputPath 'environment.txt'
          Remove-Item -Path $envFile -Force -ErrorAction SilentlyContinue
          Set-Content -Path $envFile -Value $envValue
          Write-Host "Environment written to: $envFile" -ForegroundColor Green

  build-uipath-nuget-package:
    needs: [config]
    if: needs.config.outputs.build == 'Yes'
    runs-on: self-hosted
    steps: 
      # ✅ SAME ENHANCED CHECKOUT FOR BUILD JOB
      - name: Force fresh repository checkout for build
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          force: true
          submodules: false
          token: ${{ github.token }}
          
      - name: Verify build files are current
        shell: pwsh
        run: |
          Write-Host "=== BUILD FILES VERIFICATION ===" -ForegroundColor Yellow
          
          # Check critical build files
          $buildFiles = @("project.json", "scripts/UiPathPack.ps1", "Configue-CICD.txt")
          foreach ($file in $buildFiles) {
            $fullPath = Join-Path "${{ github.workspace }}" $file
            if (Test-Path $fullPath) {
              $lastWrite = (Get-Item $fullPath).LastWriteTime
              $size = (Get-Item $fullPath).Length
              Write-Host "✅ $file (Modified: $lastWrite, Size: $size bytes)" -ForegroundColor Green
            } else {
              Write-Host "❌ Missing build file: $file" -ForegroundColor Red
            }
          }
          
      - name: Load config values from Configue-CICD.txt
        id: load_config
        shell: pwsh
        run: |
          $configFile = "${{ github.workspace }}\Configue-CICD.txt"
          if (-not (Test-Path $configFile)) {
            Write-Error "Configuration file not found for build: $configFile"
            exit 1
          }
          
          Write-Host "Loading build configuration..." -ForegroundColor Yellow
          $config = Get-Content $configFile
          foreach ($line in $config) {
            if ($line -match '^[ ]*PROJECT_NAME[ ]*-[ ]*(.+)$') { echo "PROJECT_NAME=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*BRANCH[ ]*-[ ]*(.+)$') { echo "BRANCH=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*UIPATH_CLI_PATH[ ]*-[ ]*(.+)$') { echo "UIPATH_CLI_PATH=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*FOLDER_ORGANIZATION_UNIT[ ]*-[ ]*(.+)$') { echo "FOLDER_ORG_UNIT=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*FOLDER_DEPLOY_UNIT[ ]*-[ ]*(.+)$') { echo "FOLDER_DEPLOY_UNIT=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*MACHINE[ ]*-[ ]*(.+)$') { echo "MACHINE=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*ROBOT[ ]*-[ ]*(.+)$') { echo "ROBOT=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*TIMEOUT_SEC[ ]*-[ ]*(.+)$') { echo "TIMEOUT_SEC=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
          }
          
      - name: Print loaded config values
        shell: pwsh
        run: |
          Write-Host "Build configuration loaded:" -ForegroundColor Green
          Get-ChildItem Env: | Where-Object { $_.Name -in @('PROJECT_NAME','BRANCH','UIPATH_CLI_PATH','FOLDER_ORG_UNIT','FOLDER_DEPLOY_UNIT','MACHINE','ROBOT','TIMEOUT_SEC') } | ForEach-Object { Write-Host "  $($_.Name)=$($_.Value)" }
          
      - name: Build Nuget Package
        shell: powershell
        run: ${{ github.workspace }}\scripts\UiPathPack.ps1 ${{ github.workspace }}\project.json -destination_folder ${{ github.workspace }}\package -autoVersion -uipathCliFilePath ${{ env.UIPATH_CLI_PATH }}
        
      - name: Upload UiPath Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Artifacts
          path: |
           package/*.*
           scripts/*.ps1

  run-uipath-nuget-package:
    needs: [config]
    if: needs.config.outputs.run == 'Yes'
    runs-on: self-hosted
    steps:
      # ✅ SAME ENHANCED CHECKOUT FOR RUN JOB
      - name: Force fresh repository checkout for run
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          force: true
          submodules: false
          token: ${{ github.token }}
          
      - name: Verify run files are current
        shell: pwsh
        run: |
          Write-Host "=== RUN FILES VERIFICATION ===" -ForegroundColor Yellow
          
          # Check critical run files with detailed info
          $runFiles = @("scripts/UiPathRun.ps1", "Configue-CICD.txt")
          foreach ($file in $runFiles) {
            $fullPath = Join-Path "${{ github.workspace }}" $file
            if (Test-Path $fullPath) {
              $fileInfo = Get-Item $fullPath
              $hash = Get-FileHash $fullPath -Algorithm SHA256
              Write-Host "✅ $file" -ForegroundColor Green
              Write-Host "   Modified: $($fileInfo.LastWriteTime)" -ForegroundColor Cyan
              Write-Host "   Size: $($fileInfo.Length) bytes" -ForegroundColor Cyan
              Write-Host "   Hash: $($hash.Hash.Substring(0,16))..." -ForegroundColor Cyan
            } else {
              Write-Host "❌ Missing run file: $file" -ForegroundColor Red
            }
          }
          
      # ... rest of your run steps remain the same ...
      
      - name: Load config values from Configue-CICD.txt
        id: load_config
        shell: pwsh
        run: |
          $configFile = "${{ github.workspace }}\Configue-CICD.txt"
          if (-not (Test-Path $configFile)) {
            Write-Error "Configuration file not found: $configFile"
            exit 1
          }
          
          Write-Host "Loading configuration from: $configFile" -ForegroundColor Yellow
          $config = Get-Content $configFile
          foreach ($line in $config) {
            if ($line -match '^[ ]*PROJECT_NAME[ ]*-[ ]*(.+)$') { echo "PROJECT_NAME=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*BRANCH[ ]*-[ ]*(.+)$') { echo "BRANCH=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*UIPATH_CLI_PATH[ ]*-[ ]*(.+)$') { echo "UIPATH_CLI_PATH=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*FOLDER_ORGANIZATION_UNIT[ ]*-[ ]*(.+)$') { echo "FOLDER_ORG_UNIT=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*FOLDER_DEPLOY_UNIT[ ]*-[ ]*(.+)$') { echo "FOLDER_DEPLOY_UNIT=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*MACHINE[ ]*-[ ]*(.+)$') { echo "MACHINE=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*ROBOT[ ]*-[ ]*(.+)$') { echo "ROBOT=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*TIMEOUT_SEC[ ]*-[ ]*(.+)$') { echo "TIMEOUT_SEC=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
          }

      - name: Print loaded config values
        shell: pwsh
        run: |
          Write-Host "Configuration values loaded:" -ForegroundColor Yellow
          Get-ChildItem Env: | Where-Object { $_.Name -in @(
            'PROJECT_NAME','BRANCH','UIPATH_CLI_PATH',
            'FOLDER_ORG_UNIT','FOLDER_DEPLOY_UNIT',
            'MACHINE','ROBOT','TIMEOUT_SEC'
          ) } | ForEach-Object { Write-Host "  $($_.Name)=$($_.Value)" -ForegroundColor Cyan }

      - name: Debug UIPATH_CLI_PATH
        shell: pwsh
        run: |
          Write-Host "UIPATH_CLI_PATH: '$env:UIPATH_CLI_PATH'" -ForegroundColor Yellow
          if ($env:UIPATH_CLI_PATH) {
            Write-Host "File exists: $(Test-Path -Path $env:UIPATH_CLI_PATH)" -ForegroundColor Yellow
            if (Test-Path -Path $env:UIPATH_CLI_PATH) {
              Write-Host "CLI Version:" -ForegroundColor Yellow
              & "$env:UIPATH_CLI_PATH" --version 2>&1 | Write-Host -ForegroundColor Cyan
            }
          } else {
            Write-Host "UIPATH_CLI_PATH is not set!" -ForegroundColor Red
          }

      - name: Run Package
        shell: pwsh
        run: |
          Write-Host "PROJECT_NAME from config: $env:PROJECT_NAME" -ForegroundColor Yellow
          Write-Host "Executing UiPath Run script..." -ForegroundColor Yellow
          
          # Validate required parameters before execution
          if ([string]::IsNullOrEmpty($env:PROJECT_NAME)) {
            Write-Error "PROJECT_NAME is empty or not set"
            exit 1
          }
          
          if ([string]::IsNullOrEmpty($env:UIPATH_CLI_PATH)) {
            Write-Error "UIPATH_CLI_PATH is empty or not set"
            exit 1
          }
          
          # Verify script file exists and is current
          $scriptPath = "${{ github.workspace }}\scripts\UiPathRun.ps1"
          if (-not (Test-Path $scriptPath)) {
            Write-Error "UiPath Run script not found: $scriptPath"
            exit 1
          }
          
          $scriptInfo = Get-Item $scriptPath
          Write-Host "Using script: $scriptPath (Modified: $($scriptInfo.LastWriteTime))" -ForegroundColor Cyan
          
          try {
            & $scriptPath `
              -processName "$env:PROJECT_NAME" `
              -uriOrch "$env:ORCH_URL" `
              -tenantlName "$env:ORCH_TENANT" `
              -accountForApp "$env:ORCH_ACC_NAME" `
              -applicationId "0df2fe2f-f8df-45bd-9777-88ab4ce30689" `
              -applicationScope "OR.Execution OR.Jobs OR.Robots" `
              -folder_organization_unit "$env:FOLDER_ORG_UNIT" `
              -machine "$env:MACHINE" `
              -robots "$env:ROBOT" `
              -uipathCliFilePath "$env:UIPATH_CLI_PATH" `
              -timeout ([int]$env:TIMEOUT_SEC)
          } catch {
            Write-Error "Failed to execute UiPath Run script: $_"
            exit 1
          }

  publish-uipath-nuget-package:
     needs: [run-uipath-nuget-package, config]
     if: needs.config.outputs.deploy == 'Yes'
     runs-on: self-hosted
     steps: 
      # ✅ ENHANCED CHECKOUT FOR DEPLOY JOB
      - name: Force fresh repository checkout for deploy
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
          force: true
          submodules: false
          token: ${{ github.token }}
        
      - name: Download UiPath Artifacts
        uses: actions/download-artifact@v4
        with:
          name: Artifacts
          
      - name: Load config values from Configue-CICD.txt
        id: load_config
        shell: pwsh
        run: |
          $configFile = "${{ github.workspace }}\Configue-CICD.txt"
          if (-not (Test-Path $configFile)) {
            Write-Error "Configuration file not found for deploy: $configFile"
            exit 1
          }
          
          $config = Get-Content $configFile
          foreach ($line in $config) {
            if ($line -match '^[ ]*UIPATH_CLI_PATH[ ]*-[ ]*(.+)$') { echo "UIPATH_CLI_PATH=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*FOLDER_ORGANIZATION_UNIT[ ]*-[ ]*(.+)$') { echo "FOLDER_ORG_UNIT=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
            if ($line -match '^[ ]*FOLDER_DEPLOY_UNIT[ ]*-[ ]*(.+)$') { echo "FOLDER_DEPLOY_UNIT=$($Matches[1].Trim())" >> $env:GITHUB_ENV }
          }
          
      - name: Publish Nuget Package to DEV
        shell: powershell
        run: ${{ github.workspace }}\scripts\UiPathDeploy.ps1 ${{ github.workspace }}\package ${{env.ORCH_URL}} ${{env.ORCH_TENANT}} -UserKey ${{env.ORCH_USER_KEY}} -account_name ${{env.ORCH_ACC_NAME}} -folder_organization_unit ${{ env.FOLDER_DEPLOY_UNIT }} -uipathCliFilePath ${{ env.UIPATH_CLI_PATH }}
